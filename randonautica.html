<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Randonaut ‚ú¶</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;900&family=Crimson+Pro:ital,wght@0,300;0,400;1,300;1,400&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
:root {
  --void:#04050a; --deep:#080c18; --border:rgba(138,110,255,0.25);
  --glow:#8a6eff; --text:#d4ceff; --muted:#5a5478;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html,body{height:100%;overflow:hidden;background:var(--void);font-family:'Space Mono',monospace;}

/* SCREENS */
.screen{
  position:fixed;inset:0;z-index:10;
  display:flex;flex-direction:column;
  align-items:center;justify-content:center;
  padding:24px 20px;overflow-y:auto;
  opacity:0;pointer-events:none;
  transition:opacity 0.5s ease;
  -webkit-overflow-scrolling:touch;
}
.screen.active{opacity:1;pointer-events:all;}

/* STARS */
#stars{position:fixed;inset:0;z-index:0;pointer-events:none;}

/* INTRO */
#screen-intro{
  background:radial-gradient(ellipse at 50% 30%,rgba(138,110,255,0.15) 0%,transparent 70%),var(--void);
  text-align:center;gap:12px;
}
.sigil{width:110px;height:110px;animation:spin 20s linear infinite;filter:drop-shadow(0 0 20px rgba(138,110,255,0.6));}
@keyframes spin{to{transform:rotate(360deg)}}
.title-main{font-family:'Cinzel',serif;font-size:2.2rem;font-weight:900;letter-spacing:6px;color:#fff;text-shadow:0 0 30px rgba(138,110,255,0.8);}
.title-sub{font-family:'Crimson Pro',serif;font-style:italic;font-size:1rem;color:var(--muted);letter-spacing:3px;}

/* BUTTONS */
.btn{
  width:100%;max-width:300px;
  padding:15px 20px;
  font-family:'Cinzel',serif;font-size:0.9rem;letter-spacing:3px;
  cursor:pointer;border:1px solid var(--border);
  background:rgba(138,110,255,0.1);color:var(--text);
  transition:all 0.2s;-webkit-appearance:none;
}
.btn.primary{background:rgba(138,110,255,0.25);border-color:rgba(138,110,255,0.6);color:#fff;font-size:1rem;}
.btn:active{opacity:0.7;}
.btn:disabled{opacity:0.4;cursor:not-allowed;}

/* SETUP */
#screen-setup{background:var(--deep);justify-content:flex-start;padding-top:56px;gap:0;}
.top-bar{width:100%;display:flex;align-items:center;gap:12px;margin-bottom:24px;}
.back-btn{background:none;border:1px solid var(--border);color:var(--muted);font-family:'Cinzel',serif;font-size:0.65rem;letter-spacing:2px;padding:8px 12px;cursor:pointer;}
.screen-title{font-family:'Cinzel',serif;font-size:0.9rem;letter-spacing:4px;color:var(--text);}
.lbl{font-family:'Cinzel',serif;font-size:0.62rem;letter-spacing:3px;color:var(--muted);margin-bottom:10px;width:100%;text-transform:uppercase;}
textarea.intent{
  width:100%;background:rgba(138,110,255,0.05);border:1px solid var(--border);
  color:var(--text);font-family:'Crimson Pro',serif;font-size:1.05rem;
  padding:12px;outline:none;resize:none;height:76px;margin-bottom:20px;
}
textarea.intent::placeholder{color:var(--muted);font-style:italic;}
textarea.intent:focus{border-color:rgba(138,110,255,0.5);}
.radius-num{font-family:'Cinzel',serif;font-size:1.8rem;font-weight:600;color:#fff;text-align:center;letter-spacing:2px;}
.radius-unit{font-size:0.85rem;color:var(--muted);}
input[type=range]{
  -webkit-appearance:none;width:100%;height:3px;
  background:linear-gradient(to right,var(--glow) 0%,var(--glow) var(--pct,20%),rgba(138,110,255,0.2) var(--pct,20%));
  outline:none;cursor:pointer;margin:14px 0 20px;
}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:24px;height:24px;border-radius:50%;background:var(--glow);box-shadow:0 0 10px rgba(138,110,255,0.8);cursor:pointer;}
.type-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;width:100%;margin-bottom:20px;}
.type-card{
  background:rgba(255,255,255,0.03);border:1px solid var(--border);
  padding:12px 10px;cursor:pointer;text-align:center;transition:all 0.2s;
}
.type-card.sel{border-color:var(--tc);background:rgba(var(--tr),0.1);box-shadow:inset 0 0 15px rgba(var(--tr),0.1);}
.type-card span{display:block;}
.ti{font-size:1.6rem;margin-bottom:4px;}
.tn{font-family:'Cinzel',serif;font-size:0.65rem;letter-spacing:2px;color:var(--text);margin-bottom:3px;}
.th{font-family:'Crimson Pro',serif;font-size:0.72rem;color:var(--muted);font-style:italic;}
.scroll-area{overflow-y:auto;width:100%;flex:1;padding-bottom:30px;-webkit-overflow-scrolling:touch;}

/* GPS */
#screen-gps{
  background:radial-gradient(ellipse at 50% 40%,rgba(110,255,180,0.08) 0%,transparent 65%),var(--deep);
  text-align:center;gap:16px;
}
.gps-icon{font-size:3.5rem;}
.gps-title{font-family:'Cinzel',serif;font-size:1.2rem;letter-spacing:4px;color:#fff;}
.gps-desc{font-family:'Crimson Pro',serif;font-style:italic;font-size:0.95rem;color:var(--muted);max-width:280px;line-height:1.7;}
.gps-list{
  width:100%;max-width:300px;background:rgba(110,255,180,0.04);
  border:1px solid rgba(110,255,180,0.15);padding:14px;
  font-family:'Crimson Pro',serif;font-size:0.85rem;color:var(--muted);line-height:1.9;text-align:left;
}
#gps-status{font-family:'Crimson Pro',serif;font-size:0.85rem;color:var(--muted);min-height:18px;font-style:italic;}

/* GENERATE */
#screen-generate{
  background:radial-gradient(ellipse at 50% 40%,rgba(138,110,255,0.08) 0%,transparent 65%),var(--deep);
  text-align:center;gap:20px;
}
.type-badge{
  font-family:'Cinzel',serif;font-size:0.65rem;letter-spacing:3px;
  padding:5px 14px;border:1px solid;display:inline-block;
}
.orb-wrap{position:relative;width:170px;height:170px;cursor:pointer;}
.orb{
  width:100%;height:100%;border-radius:50%;
  display:flex;align-items:center;justify-content:center;font-size:3.2rem;
  border:1px solid rgba(138,110,255,0.4);
  box-shadow:0 0 40px rgba(138,110,255,0.3),0 0 80px rgba(138,110,255,0.1);
  animation:breathe 4s ease-in-out infinite;
  background:radial-gradient(ellipse at 35% 35%,rgba(138,110,255,0.3) 0%,rgba(138,110,255,0.05) 60%,transparent 80%);
  transition:all 0.3s;
}
.orb:active{transform:scale(0.93);}
@keyframes breathe{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
.ring1{position:absolute;inset:-14px;border-radius:50%;border:1px dashed rgba(138,110,255,0.25);animation:spin 8s linear infinite;}
.ring2{position:absolute;inset:-28px;border-radius:50%;border:1px dashed rgba(138,110,255,0.12);animation:spin 15s linear infinite reverse;}
.gen-hint{font-family:'Crimson Pro',serif;font-style:italic;font-size:0.9rem;color:var(--muted);}
.gen-intent{font-family:'Crimson Pro',serif;font-style:italic;font-size:0.95rem;color:var(--text);max-width:260px;line-height:1.5;}
.gen-radius{font-family:'Cinzel',serif;font-size:0.7rem;letter-spacing:2px;color:var(--muted);}

/* LOADING */
#screen-loading{background:var(--deep);text-align:center;gap:18px;}
.load-sigil{width:70px;height:70px;animation:spin 1.8s linear infinite;filter:drop-shadow(0 0 12px rgba(138,110,255,0.7));}
.load-title{font-family:'Cinzel',serif;font-size:0.75rem;letter-spacing:4px;color:var(--muted);animation:fade-p 1.5s ease-in-out infinite;}
@keyframes fade-p{0%,100%{opacity:0.4}50%{opacity:1}}
#load-phase{font-family:'Crimson Pro',serif;font-style:italic;font-size:0.9rem;color:var(--text);min-height:22px;}

/* MAP SCREEN - critical: must be full height */
#screen-map{
  padding:0;justify-content:flex-start;background:var(--void);
  display:flex;flex-direction:column;
}
#map-container{
  flex:1;width:100%;position:relative;min-height:0;
}
#the-map{width:100%;height:100%;}
.map-top{
  position:absolute;top:0;left:0;right:0;z-index:1000;pointer-events:none;
  background:linear-gradient(to bottom,rgba(4,5,10,0.92),transparent);
  padding:10px 14px 20px;
  display:flex;align-items:center;gap:10px;
}
.map-top button{pointer-events:all;}
.map-pill{
  font-family:'Cinzel',serif;font-size:0.62rem;letter-spacing:2px;
  padding:5px 10px;border:1px solid;
}
.map-bottom{
  background:rgba(4,5,10,0.97);
  padding:16px;border-top:1px solid var(--border);
  flex-shrink:0;
}
.dest-row{display:flex;align-items:center;gap:10px;margin-bottom:10px;}
.dest-icon-big{font-size:1.7rem;}
.dest-name-txt{font-family:'Cinzel',serif;font-size:0.8rem;letter-spacing:2px;color:#fff;}
.dest-dist-txt{font-family:'Crimson Pro',serif;font-size:0.85rem;color:var(--muted);}
.dest-coords-txt{font-family:'Cinzel',serif;font-size:0.6rem;letter-spacing:1px;color:var(--muted);margin-bottom:12px;}
.map-btns{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
.map-btn{
  background:rgba(255,255,255,0.04);border:1px solid var(--border);
  color:var(--text);font-family:'Cinzel',serif;font-size:0.65rem;
  letter-spacing:2px;padding:11px 6px;cursor:pointer;text-align:center;
  -webkit-appearance:none;
}
.map-btn:active{background:rgba(138,110,255,0.15);}
.map-btn.full{grid-column:1/-1;border-color:rgba(138,110,255,0.5);color:rgb(138,110,255);}

/* Leaflet dark mode */
.leaflet-tile{filter:invert(1) hue-rotate(180deg) brightness(0.75) saturate(0.6);}
.leaflet-container{background:#04050a;}
.leaflet-control-zoom{display:none!important;}

/* Custom markers */
.me-dot{
  width:16px;height:16px;border-radius:50%;
  background:#fff;border:3px solid #8a6eff;
  box-shadow:0 0 14px rgba(138,110,255,0.9);
  animation:me-p 2s ease-in-out infinite;
}
@keyframes me-p{0%,100%{box-shadow:0 0 14px rgba(138,110,255,0.9)}50%{box-shadow:0 0 28px rgba(138,110,255,1)}}
.dest-pin{display:flex;flex-direction:column;align-items:center;animation:bob 2s ease-in-out infinite;}
@keyframes bob{0%,100%{transform:translateY(0)}50%{transform:translateY(-5px)}}
.dest-pin-inner{
  width:44px;height:44px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  font-size:1.4rem;border:2px solid;
}
.dest-pin-tail{width:6px;height:6px;border-radius:50%;margin-top:3px;}

/* ANOMALY INFO */
#screen-anomaly{background:var(--deep);justify-content:flex-start;padding-top:56px;gap:0;}
.anom-hero{width:100%;padding:24px 16px;text-align:center;margin-bottom:16px;}
.anom-icon{font-size:3.5rem;display:block;margin-bottom:10px;}
.anom-name{font-family:'Cinzel',serif;font-size:1.4rem;font-weight:900;letter-spacing:4px;margin-bottom:6px;}
.anom-tag{font-family:'Crimson Pro',serif;font-style:italic;font-size:0.95rem;color:var(--muted);}
.info-block{
  width:100%;background:rgba(255,255,255,0.02);
  border:1px solid var(--border);border-left:3px solid;
  padding:14px;margin-bottom:10px;
}
.info-block-t{font-family:'Cinzel',serif;font-size:0.6rem;letter-spacing:3px;color:var(--muted);margin-bottom:7px;}
.info-block-b{font-family:'Crimson Pro',serif;font-size:0.95rem;color:var(--text);line-height:1.7;}

/* RESULT */
#screen-result{background:var(--deep);justify-content:flex-start;padding-top:60px;text-align:center;gap:0;}
.res-aura{
  width:76px;height:76px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;font-size:2.3rem;
  margin:0 auto 18px;border:1px solid;
}
.res-title{font-family:'Cinzel',serif;font-size:1rem;letter-spacing:4px;color:#fff;margin-bottom:6px;}
.res-sub{font-family:'Crimson Pro',serif;font-style:italic;font-size:0.9rem;color:var(--muted);margin-bottom:22px;padding:0 10px;line-height:1.6;}
textarea.journal{
  width:100%;background:rgba(255,255,255,0.03);border:1px solid var(--border);
  color:var(--text);font-family:'Crimson Pro',serif;font-size:1rem;
  padding:12px;resize:none;height:110px;outline:none;margin-bottom:14px;line-height:1.6;
}
textarea.journal::placeholder{color:var(--muted);font-style:italic;}
.res-actions{width:100%;display:grid;gap:10px;}

/* HISTORY */
#screen-history{background:var(--deep);justify-content:flex-start;padding-top:56px;gap:0;}
.hist-empty{text-align:center;padding:40px 20px;font-family:'Crimson Pro',serif;font-style:italic;color:var(--muted);}
.hist-card{
  width:100%;background:rgba(255,255,255,0.03);
  border:1px solid var(--border);border-left:3px solid;
  padding:13px;margin-bottom:8px;
}
.hist-top{display:flex;align-items:center;gap:8px;margin-bottom:5px;}
.hist-icon{font-size:1.2rem;}
.hist-name{font-family:'Cinzel',serif;font-size:0.7rem;letter-spacing:2px;flex:1;}
.hist-date{font-family:'Crimson Pro',serif;font-size:0.75rem;color:var(--muted);}
.hist-note{font-family:'Crimson Pro',serif;font-style:italic;font-size:0.82rem;color:var(--muted);line-height:1.5;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;}

/* TOAST */
.toast{
  position:fixed;bottom:28px;left:50%;transform:translateX(-50%);
  background:rgba(12,16,32,0.97);border:1px solid var(--border);
  color:var(--text);font-family:'Crimson Pro',serif;font-size:0.9rem;
  padding:11px 18px;z-index:9999;white-space:nowrap;
  opacity:0;transition:opacity 0.3s;pointer-events:none;
}
.toast.show{opacity:1;}
</style>
</head>
<body>
<canvas id="stars"></canvas>

<!-- GPS -->
<div id="screen-gps" class="screen active">
  <div class="gps-icon">üìç</div>
  <div class="gps-title">UBICACI√ìN</div>
  <div class="gps-desc">Para funcionar necesitamos saber d√≥nde est√°s. Tu ubicaci√≥n <strong style="color:var(--text)">nunca sale de tu dispositivo</strong>.</div>
  <div class="gps-list">
    ‚ú¶ Centrar el mapa en ti<br>
    ‚ú¶ Calcular el radio de b√∫squeda<br>
    ‚ú¶ Distancia al destino en tiempo real<br>
    ‚ú¶ Actualizarse mientras caminas
  </div>
  <div id="gps-status"></div>
  <button id="gps-btn" class="btn primary" onclick="requestGPS()">üìç PERMITIR UBICACI√ìN</button>
  <button class="btn" style="font-size:0.75rem" onclick="useFallback()">Continuar sin GPS</button>
</div>

<!-- INTRO -->
<div id="screen-intro" class="screen">
  <svg class="sigil" viewBox="0 0 120 120" fill="none">
    <circle cx="60" cy="60" r="55" stroke="rgba(138,110,255,0.3)" stroke-width="1"/>
    <circle cx="60" cy="60" r="40" stroke="rgba(138,110,255,0.2)" stroke-width="1" stroke-dasharray="4 4"/>
    <path d="M60 5 L60 115 M5 60 L115 60" stroke="rgba(138,110,255,0.15)" stroke-width="0.5"/>
    <path d="M60 5 L113 37.5 L113 82.5 L60 115 L7 82.5 L7 37.5 Z" stroke="rgba(255,110,180,0.25)" stroke-width="1" fill="none"/>
    <path d="M60 20 L95 42 L95 78 L60 100 L25 78 L25 42 Z" stroke="rgba(138,110,255,0.4)" stroke-width="1" fill="none"/>
    <circle cx="60" cy="60" r="8" stroke="rgba(255,110,180,0.6)" stroke-width="1.5" fill="rgba(255,110,180,0.1)"/>
    <path d="M60 52 L60 35 M60 68 L60 85 M52 60 L35 60 M68 60 L85 60" stroke="rgba(255,110,180,0.4)" stroke-width="1"/>
    <circle cx="60" cy="20" r="3" fill="rgba(138,110,255,0.8)"/>
    <circle cx="95" cy="42" r="3" fill="rgba(138,110,255,0.6)"/>
    <circle cx="95" cy="78" r="3" fill="rgba(138,110,255,0.6)"/>
    <circle cx="60" cy="100" r="3" fill="rgba(138,110,255,0.8)"/>
    <circle cx="25" cy="78" r="3" fill="rgba(138,110,255,0.6)"/>
    <circle cx="25" cy="42" r="3" fill="rgba(138,110,255,0.6)"/>
  </svg>
  <div class="title-main">RANDONAUT</div>
  <div class="title-sub" style="margin-bottom:32px">explora lo desconocido</div>
  <button class="btn primary" onclick="goTo('setup')">‚ú¶ INICIAR EXPLORACI√ìN</button>
  <button class="btn" onclick="goTo('history')">HISTORIAL DE VIAJES</button>
</div>

<!-- SETUP -->
<div id="screen-setup" class="screen">
  <div class="top-bar">
    <button class="back-btn" onclick="goTo('intro')">‚Üê VOLVER</button>
    <div class="screen-title">CONFIGURAR</div>
  </div>
  <div class="scroll-area">
    <div class="lbl">‚ú¶ tu intenci√≥n</div>
    <textarea class="intent" id="intent-input" placeholder="Una palabra, emoci√≥n o deseo..."></textarea>
    <div class="lbl">‚ú¶ radio de b√∫squeda</div>
    <div class="radius-num"><span id="rad-val">1000</span> <span class="radius-unit" id="rad-unit">m</span></div>
    <input type="range" id="rad-slider" min="200" max="5000" step="100" value="1000" oninput="updateRadius(this)">
    <div class="lbl">‚ú¶ tipo de anomal√≠a</div>
    <div class="type-grid" id="type-grid">
      <div class="type-card sel" data-t="attractor" style="--tc:#6effb4;--tr:110,255,180" onclick="selType(this)">
        <span class="ti">üåÄ</span><span class="tn">ATTRACTOR</span><span class="th">energ√≠a concentrada</span>
      </div>
      <div class="type-card" data-t="void" style="--tc:#6ebbff;--tr:110,187,255" onclick="selType(this)">
        <span class="ti">üï≥Ô∏è</span><span class="tn">VOID</span><span class="th">vac√≠o cu√°ntico</span>
      </div>
      <div class="type-card" data-t="anomaly" style="--tc:#ff6eb4;--tr:255,110,180" onclick="selType(this)">
        <span class="ti">‚ö°</span><span class="tn">ANOMALY</span><span class="th">punto estad√≠stico raro</span>
      </div>
      <div class="type-card" data-t="power" style="--tc:#ffdd6e;--tr:255,221,110" onclick="selType(this)">
        <span class="ti">‚ú®</span><span class="tn">POWER</span><span class="th">convergencia m√°xima</span>
      </div>
    </div>
    <button class="btn" style="max-width:100%;margin-bottom:10px" onclick="showAnomalyInfo()">‚ùì ¬øQu√© significa cada tipo?</button>
    <button class="btn primary" style="max-width:100%;margin-bottom:0" onclick="goToGenerate()">CONTINUAR ‚Üí</button>
    <div style="height:20px"></div>
  </div>
</div>

<!-- ANOMALY INFO -->
<div id="screen-anomaly" class="screen">
  <div class="top-bar">
    <button class="back-btn" onclick="goTo('setup')">‚Üê VOLVER</button>
    <div class="screen-title">TIPOS</div>
  </div>
  <div class="scroll-area" id="anomaly-content"></div>
</div>

<!-- GENERATE -->
<div id="screen-generate" class="screen">
  <div class="type-badge" id="gen-badge" style="border-color:rgba(110,255,180,0.5);color:#6effb4;background:rgba(110,255,180,0.08)">ATTRACTOR</div>
  <div class="gen-intent" id="gen-intent" style="display:none"></div>
  <div class="orb-wrap" onclick="generatePoint()">
    <div class="ring2"></div>
    <div class="ring1"></div>
    <div class="orb" id="gen-orb">üåÄ</div>
  </div>
  <div class="gen-hint">Toca el orbe para generar</div>
  <div class="gen-radius" id="gen-radius">Radio: 1000m</div>
  <button class="btn" style="max-width:200px;font-size:0.75rem" onclick="goTo('setup')">‚Üê AJUSTES</button>
</div>

<!-- LOADING -->
<div id="screen-loading" class="screen">
  <svg class="load-sigil" viewBox="0 0 80 80" fill="none">
    <circle cx="40" cy="40" r="35" stroke="rgba(138,110,255,0.5)" stroke-width="1.5" stroke-dasharray="6 4"/>
    <circle cx="40" cy="40" r="22" stroke="rgba(255,110,180,0.4)" stroke-width="1" stroke-dasharray="3 5"/>
    <circle cx="40" cy="40" r="6" fill="rgba(138,110,255,0.6)"/>
  </svg>
  <div class="load-title">CALCULANDO</div>
  <div id="load-phase">Consultando el campo cu√°ntico...</div>
</div>

<!-- MAP -->
<div id="screen-map" class="screen">
  <div id="map-container">
    <div id="the-map"></div>
    <div class="map-top">
      <button class="back-btn" onclick="goTo('generate')" style="pointer-events:all">‚Üê</button>
      <div class="map-pill" id="map-pill" style="border-color:rgba(110,255,180,0.5);color:#6effb4;background:rgba(110,255,180,0.08)">ATTRACTOR</div>
    </div>
  </div>
  <div class="map-bottom">
    <div class="dest-row">
      <div class="dest-icon-big" id="dest-icon">üåÄ</div>
      <div>
        <div class="dest-name-txt" id="dest-name">PUNTO ATTRACTOR</div>
        <div class="dest-dist-txt" id="dest-dist">Calculando...</div>
      </div>
    </div>
    <div class="dest-coords-txt" id="dest-coords">---.-----¬∞, ---.-----¬∞</div>
    <div class="map-btns">
      <button class="map-btn" onclick="openGoogleMaps()">üó∫Ô∏è Google Maps</button>
      <button class="map-btn" onclick="openWaze()">üöó Waze</button>
      <button class="map-btn" onclick="recenterBoth()">üéØ Ver todo</button>
      <button class="map-btn" onclick="recenterMe()">üìç Mi posici√≥n</button>
      <button class="map-btn full" onclick="arrive()">‚ú¶ LLEGU√â AL DESTINO</button>
    </div>
  </div>
</div>

<!-- RESULT -->
<div id="screen-result" class="screen">
  <div class="res-aura" id="res-aura">üåÄ</div>
  <div class="res-title">¬øQU√â ENCONTRASTE?</div>
  <div class="res-sub">Registra tu experiencia. El universo siempre tiene algo que mostrar.</div>
  <textarea class="journal" id="journal" placeholder="Describe lo que viste, sentiste o descubriste..."></textarea>
  <div class="res-actions">
    <button class="btn primary" style="max-width:100%;margin:0" onclick="saveEntry()">‚ú¶ GUARDAR EXPERIENCIA</button>
    <button class="btn" style="max-width:100%;margin:0" onclick="goTo('setup')">‚Ü∫ NUEVA EXPLORACI√ìN</button>
  </div>
</div>

<!-- HISTORY -->
<div id="screen-history" class="screen">
  <div class="top-bar">
    <button class="back-btn" onclick="goTo('intro')">‚Üê VOLVER</button>
    <div class="screen-title">HISTORIAL</div>
  </div>
  <div class="scroll-area" id="hist-list"></div>
</div>

<div class="toast" id="toast"></div>

<script>
// ‚îÄ‚îÄ STARS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const canvas = document.getElementById('stars');
const ctx = canvas.getContext('2d');
let stars = [];
function resizeCanvas(){
  canvas.width = window.innerWidth; canvas.height = window.innerHeight;
  stars = Array.from({length:100},()=>({x:Math.random()*canvas.width,y:Math.random()*canvas.height,r:Math.random()*1.2+0.2,o:Math.random()*0.5+0.1,s:(Math.random()-0.5)*0.08}));
}
(function animStars(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  stars.forEach(s=>{s.o+=s.s;if(s.o>0.65||s.o<0.05)s.s*=-1;ctx.beginPath();ctx.arc(s.x,s.y,s.r,0,Math.PI*2);ctx.fillStyle=`rgba(200,190,255,${s.o})`;ctx.fill();});
  requestAnimationFrame(animStars);
})();
resizeCanvas();
window.addEventListener('resize',resizeCanvas);

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let cur = 'gps';
let selTyp = 'attractor';
let intent = '', radius = 1000;
let myLat = null, myLng = null, dLat, dLng;
let leafMap = null, meMark = null, dMark = null, radCirc = null, pathLine = null;
let watchId = null;
let gpsOk = false;
let curEntry = null;

const TYPES = {
  attractor:{name:'ATTRACTOR',icon:'üåÄ',color:'#6effb4',rgb:'110,255,180',
    tagline:'Donde la energ√≠a converge',
    what:'Un punto donde los n√∫meros aleatorios cu√°nticos se agrupan estad√≠sticamente, como si algo "atrajera" la aleatoriedad hacia ese lugar.',
    expect:'Lugares con mucha energ√≠a humana: plazas, graffitis, √°rboles viejos, esculturas. Algo que llame poderosamente tu atenci√≥n sin raz√≥n aparente.',
    ritual:'Al llegar, detente. Cierra los ojos 10 segundos. ¬øQu√© sientes? Nota colores, sonidos y sensaciones.',
    best:'Cuando buscas encontrar algo o tienes una pregunta sin respuesta.'},
  void:{name:'VOID',icon:'üï≥Ô∏è',color:'#6ebbff',rgb:'110,187,255',
    tagline:'El vac√≠o entre las cosas',
    what:'Lo opuesto al Attractor: un "hueco" estad√≠stico donde la aleatoriedad cu√°ntica se dispersa al m√°ximo.',
    expect:'Lugares vac√≠os o abandonados. Callejones olvidados, parques desiertos, espacios que la gente pasa por alto.',
    ritual:'Si√©ntate en silencio. El Void invita a la reflexi√≥n. ¬øQu√© pensamientos llegan?',
    best:'Cuando necesitas claridad mental o silencio interior.'},
  anomaly:{name:'ANOMALY',icon:'‚ö°',color:'#ff6eb4',rgb:'255,110,180',
    tagline:'Donde las probabilidades fallan',
    what:'Un punto estad√≠sticamente tan improbable que desaf√≠a el azar. Como un error en la matriz.',
    expect:'Cosas fuera de lugar: arte callejero extra√±o, objetos abandonados, encuentros inesperados.',
    ritual:'Documenta todo con fotos. Las anomal√≠as revelan sus secretos despu√©s, no en el momento.',
    best:'Para quienes buscan sincron√≠as o "glitches en la realidad".'},
  power:{name:'POWER',icon:'‚ú®',color:'#ffdd6e',rgb:'255,221,110',
    tagline:'La convergencia m√°xima',
    what:'Combina Attractor y Anomaly: energ√≠a concentrada en un lugar estad√≠sticamente singular.',
    expect:'Algo significativo que conecta con tu intenci√≥n de forma inexplicable.',
    ritual:'Lleva un objeto personal. Pasa al menos 5 minutos. Escribe tus pensamientos en el momento.',
    best:'Solo cuando tienes una intenci√≥n muy clara y poderosa.'}
};

// ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function goTo(scr){
  document.getElementById('screen-'+cur).classList.remove('active');
  document.getElementById('screen-'+scr).classList.add('active');
  cur = scr;
  if(scr==='history') renderHistory();
  // Invalidate map size when showing map screen
  if(scr==='map' && leafMap){
    setTimeout(()=>{ leafMap.invalidateSize(); },100);
  }
}

// ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toast(msg,dur=2500){
  const el=document.getElementById('toast');
  el.textContent=msg;el.classList.add('show');
  setTimeout(()=>el.classList.remove('show'),dur);
}

// ‚îÄ‚îÄ GPS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function requestGPS(){
  if(!navigator.geolocation){
    toast('‚ö†Ô∏è Sin soporte GPS');
    useFallback();
    return;
  }
  const btn=document.getElementById('gps-btn');
  const st=document.getElementById('gps-status');
  btn.textContent='Obteniendo...';
  btn.disabled=true;
  st.textContent='Esperando permiso...';
  st.style.color='';

  navigator.geolocation.getCurrentPosition(
    pos=>{
      myLat=pos.coords.latitude; myLng=pos.coords.longitude; gpsOk=true;
      st.textContent=`‚ú¶ ${myLat.toFixed(4)}, ${myLng.toFixed(4)}`;
      st.style.color='#6effb4';
      btn.textContent='‚ú¶ CONTINUAR ‚Üí'; btn.disabled=false;
      btn.onclick=()=>goTo('intro');
      startWatch();
    },
    err=>{
      const msgs={1:'Permiso denegado.',2:'GPS no disponible.',3:'Tiempo agotado.'};
      st.textContent='‚ö†Ô∏è '+(msgs[err.code]||'Error GPS')+' Modo sin GPS.';
      st.style.color='#ffaa00';
      btn.textContent='CONTINUAR SIN GPS ‚Üí'; btn.disabled=false;
      btn.onclick=()=>useFallback();
    },
    {enableHighAccuracy:true,timeout:12000,maximumAge:0}
  );
}

function useFallback(){
  myLat=-33.4489; myLng=-70.6693; gpsOk=true;
  goTo('intro');
}

function startWatch(){
  if(watchId) navigator.geolocation.clearWatch(watchId);
  watchId=navigator.geolocation.watchPosition(
    pos=>{
      myLat=pos.coords.latitude; myLng=pos.coords.longitude;
      updateMapTracking();
    },
    null,
    {enableHighAccuracy:true,maximumAge:5000}
  );
}

function updateMapTracking(){
  if(!leafMap||!meMark||myLat===null) return;
  meMark.setLatLng([myLat,myLng]);
  if(radCirc) radCirc.setLatLng([myLat,myLng]);
  if(pathLine && dLat){
    leafMap.removeLayer(pathLine);
    const t=TYPES[selTyp];
    pathLine=L.polyline([[myLat,myLng],[dLat,dLng]],{color:`rgb(${t.rgb})`,weight:1.5,dashArray:'6 6',opacity:0.5}).addTo(leafMap);
  }
  if(dLat){
    const d=haversine(myLat,myLng,dLat,dLng);
    const el=document.getElementById('dest-dist');
    if(el) el.textContent=d>=1000?`${(d/1000).toFixed(2)} km de aqu√≠`:`${Math.round(d)} m de aqu√≠`;
  }
}

// ‚îÄ‚îÄ RADIUS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateRadius(inp){
  radius=parseInt(inp.value);
  const pct=((radius-200)/(5000-200)*100).toFixed(1)+'%';
  inp.style.setProperty('--pct',pct);
  if(radius>=1000){
    document.getElementById('rad-val').textContent=(radius/1000).toFixed(radius%1000===0?0:1);
    document.getElementById('rad-unit').textContent='km';
  } else {
    document.getElementById('rad-val').textContent=radius;
    document.getElementById('rad-unit').textContent='m';
  }
}
// Init slider
document.getElementById('rad-slider').style.setProperty('--pct','20%');

// ‚îÄ‚îÄ TYPE SELECT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function selType(card){
  document.querySelectorAll('.type-card').forEach(c=>c.classList.remove('sel'));
  card.classList.add('sel');
  selTyp=card.dataset.t;
}

// ‚îÄ‚îÄ ANOMALY INFO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showAnomalyInfo(){
  const c=document.getElementById('anomaly-content');
  c.innerHTML=Object.entries(TYPES).map(([k,t])=>`
    <div class="anom-hero" style="background:radial-gradient(ellipse at 50%,rgba(${t.rgb},0.12),transparent 70%)">
      <span class="anom-icon">${t.icon}</span>
      <div class="anom-name" style="color:${t.color}">${t.name}</div>
      <div class="anom-tag">${t.tagline}</div>
    </div>
    <div class="info-block" style="border-left-color:${t.color}"><div class="info-block-t">¬øQU√â ES?</div><div class="info-block-b">${t.what}</div></div>
    <div class="info-block" style="border-left-color:${t.color}"><div class="info-block-t">¬øQU√â ESPERAR?</div><div class="info-block-b">${t.expect}</div></div>
    <div class="info-block" style="border-left-color:${t.color}"><div class="info-block-t">RITUAL AL LLEGAR</div><div class="info-block-b">${t.ritual}</div></div>
    <div class="info-block" style="border-left-color:${t.color}"><div class="info-block-t">MEJOR PARA</div><div class="info-block-b">${t.best}</div></div>
    <hr style="border:none;border-top:1px solid var(--border);margin:8px 0 20px">
  `).join('');
  goTo('anomaly');
}

// ‚îÄ‚îÄ GO TO GENERATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function goToGenerate(){
  intent=document.getElementById('intent-input').value.trim();
  const t=TYPES[selTyp];
  // Update orb
  const orb=document.getElementById('gen-orb');
  orb.textContent=t.icon;
  orb.style.background=`radial-gradient(ellipse at 35% 35%,rgba(${t.rgb},0.4) 0%,rgba(${t.rgb},0.05) 60%,transparent 80%)`;
  orb.style.borderColor=`rgba(${t.rgb},0.5)`;
  orb.style.boxShadow=`0 0 40px rgba(${t.rgb},0.35),0 0 80px rgba(${t.rgb},0.12)`;
  document.querySelectorAll('.ring1,.ring2').forEach(r=>{ r.style.borderColor=`rgba(${t.rgb},0.25)`; });
  // Badge
  const badge=document.getElementById('gen-badge');
  badge.textContent=t.name;
  badge.style.cssText=`border-color:rgba(${t.rgb},0.5);color:rgb(${t.rgb});background:rgba(${t.rgb},0.08)`;
  // Radius label
  document.getElementById('gen-radius').textContent=`Radio: ${radius>=1000?(radius/1000).toFixed(1)+'km':radius+'m'}`;
  // Intent
  const ie=document.getElementById('gen-intent');
  if(intent){ie.textContent=`"${intent}"`;ie.style.display='block';}else{ie.style.display='none';}
  goTo('generate');
}

// ‚îÄ‚îÄ GENERATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const PHASES=['Consultando el campo cu√°ntico...','Analizando fluctuaciones...','Calculando distribuci√≥n estad√≠stica...','Filtrando ruido del universo...','Convergiendo coordenadas...','Tu punto est√° listo.'];

async function generatePoint(){
  if(!gpsOk||myLat===null){ toast('‚ö†Ô∏è Esperando GPS...'); return; }
  goTo('loading');
  let p=0;
  const pe=document.getElementById('load-phase');
  const iv=setInterval(()=>{ pe.textContent=PHASES[Math.min(p++,PHASES.length-1)]; },600);
  await new Promise(r=>setTimeout(r,3600));
  clearInterval(iv);
  pe.textContent=PHASES[PHASES.length-1];
  await new Promise(r=>setTimeout(r,500));
  const pt=randPoint(myLat,myLng,radius);
  dLat=pt.lat; dLng=pt.lng;
  buildMap();
}

function randPoint(lat,lng,r){
  const rd=r/111320,u=Math.random(),v=Math.random();
  const w=rd*Math.sqrt(u),a=2*Math.PI*v;
  return {lat:lat+w*Math.cos(a),lng:lng+(w*Math.sin(a))/Math.cos(lat*Math.PI/180)};
}

function haversine(a,b,c,d){
  const R=6371000,dA=(c-a)*Math.PI/180,dB=(d-b)*Math.PI/180;
  const x=Math.sin(dA/2)**2+Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(dB/2)**2;
  return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}

// ‚îÄ‚îÄ BUILD MAP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildMap(){
  goTo('map');
  const t=TYPES[selTyp];

  // Update UI labels
  document.getElementById('map-pill').textContent=t.name;
  document.getElementById('map-pill').style.cssText=`border-color:rgba(${t.rgb},0.5);color:rgb(${t.rgb});background:rgba(${t.rgb},0.08)`;
  document.getElementById('dest-icon').textContent=t.icon;
  document.getElementById('dest-name').textContent=`PUNTO ${t.name}`;
  document.getElementById('dest-coords').textContent=`${dLat.toFixed(5)}¬∞, ${dLng.toFixed(5)}¬∞`;
  const dist=haversine(myLat,myLng,dLat,dLng);
  document.getElementById('dest-dist').textContent=dist>=1000?`${(dist/1000).toFixed(2)} km de aqu√≠`:`${Math.round(dist)} m de aqu√≠`;

  // Init map only once
  if(!leafMap){
    leafMap=L.map('the-map',{zoomControl:false,attributionControl:false});
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(leafMap);
  }

  // Clear old layers
  if(meMark) leafMap.removeLayer(meMark);
  if(dMark) leafMap.removeLayer(dMark);
  if(radCirc) leafMap.removeLayer(radCirc);
  if(pathLine) leafMap.removeLayer(pathLine);

  // Me marker
  meMark=L.marker([myLat,myLng],{
    icon:L.divIcon({className:'',html:'<div class="me-dot"></div>',iconSize:[16,16],iconAnchor:[8,8]}),
    zIndexOffset:1000
  }).addTo(leafMap);

  // Dest marker
  dMark=L.marker([dLat,dLng],{
    icon:L.divIcon({
      className:'',
      html:`<div class="dest-pin"><div class="dest-pin-inner" style="background:rgba(${t.rgb},0.15);border-color:rgb(${t.rgb});box-shadow:0 0 18px rgba(${t.rgb},0.5)">${t.icon}</div><div class="dest-pin-tail" style="background:rgb(${t.rgb})"></div></div>`,
      iconSize:[44,54],iconAnchor:[22,50]
    })
  }).addTo(leafMap);

  // Radius circle
  radCirc=L.circle([myLat,myLng],{
    radius,color:`rgb(${t.rgb})`,fillColor:`rgba(${t.rgb},0.04)`,weight:1,opacity:0.4
  }).addTo(leafMap);

  // Line
  pathLine=L.polyline([[myLat,myLng],[dLat,dLng]],{
    color:`rgb(${t.rgb})`,weight:1.5,dashArray:'6 6',opacity:0.5
  }).addTo(leafMap);

  // Fit bounds after a tick so the map container is visible
  setTimeout(()=>{
    leafMap.invalidateSize();
    leafMap.fitBounds(L.latLngBounds([[myLat,myLng],[dLat,dLng]]),{padding:[70,70]});
  },200);
}

// ‚îÄ‚îÄ MAP ACTIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function recenterBoth(){
  if(!leafMap||myLat===null||!dLat) return;
  leafMap.fitBounds(L.latLngBounds([[myLat,myLng],[dLat,dLng]]),{padding:[70,70]});
}
function recenterMe(){
  if(!leafMap||myLat===null) return;
  leafMap.setView([myLat,myLng],17,{animate:true});
}
function openGoogleMaps(){
  if(myLat===null||!dLat){toast('‚ö†Ô∏è Sin coordenadas');return;}
  window.open(`https://www.google.com/maps/dir/${myLat},${myLng}/${dLat},${dLng}`,'_blank');
}
function openWaze(){
  if(!dLat){toast('‚ö†Ô∏è Sin destino');return;}
  window.open(`https://waze.com/ul?ll=${dLat},${dLng}&navigate=yes`,'_blank');
}
function arrive(){
  const t=TYPES[selTyp];
  const a=document.getElementById('res-aura');
  a.textContent=t.icon;
  a.style.cssText=`border-color:rgb(${t.rgb});box-shadow:0 0 28px rgba(${t.rgb},0.4);background:rgba(${t.rgb},0.08)`;
  document.getElementById('journal').value='';
  curEntry={type:selTyp,intent,lat:dLat,lng:dLng,date:Date.now(),note:''};
  goTo('result');
}

// ‚îÄ‚îÄ SAVE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function saveEntry(){
  curEntry.note=document.getElementById('journal').value.trim();
  try{
    const h=JSON.parse(localStorage.getItem('rn_hist')||'[]');
    h.unshift(curEntry);
    localStorage.setItem('rn_hist',JSON.stringify(h.slice(0,50)));
  }catch(e){}
  toast('‚ú¶ Guardado');
  setTimeout(()=>goTo('intro'),1500);
}

// ‚îÄ‚îÄ HISTORY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderHistory(){
  const el=document.getElementById('hist-list');
  let h=[];
  try{h=JSON.parse(localStorage.getItem('rn_hist')||'[]');}catch(e){}
  if(!h.length){el.innerHTML='<div class="hist-empty">Sin viajes guardados a√∫n.<br>¬°Sal a explorar! üåÄ</div>';return;}
  el.innerHTML=h.map(e=>{
    const t=TYPES[e.type]||TYPES.attractor;
    const d=new Date(e.date).toLocaleDateString('es-CL',{day:'2-digit',month:'short',year:'numeric'});
    return `<div class="hist-card" style="border-left-color:${t.color}">
      <div class="hist-top">
        <div class="hist-icon">${t.icon}</div>
        <div class="hist-name" style="color:${t.color}">${t.name}</div>
        <div class="hist-date">${d}</div>
      </div>
      ${e.intent?`<div style="font-family:'Crimson Pro',serif;font-size:0.78rem;color:rgba(212,206,255,0.45);font-style:italic;margin-bottom:4px">"${e.intent}"</div>`:''}
      <div class="hist-note">${e.note||'Sin nota.'}</div>
    </div>`;
  }).join('');
}
</script>
</body>
</html>
