<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Randonaut ‚ú¶</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;900&family=Crimson+Pro:ital,wght@0,300;0,400;1,300;1,400&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
:root {
  --void: #04050a;
  --deep: #080c18;
  --card: #0c1020;
  --border: rgba(138,110,255,0.25);
  --glow: #8a6eff;
  --glow2: #ff6eb4;
  --gold: #c9a84c;
  --text: #d4ceff;
  --muted: #5a5478;
  --attractor: #6effb4;
  --void-col: #6ebbff;
  --anomaly: #ff6eb4;
  --power: #ffdd6e;
}
* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
html, body { height:100%; overflow:hidden; background:var(--void); }

/* ‚îÄ‚îÄ CANVAS STARS ‚îÄ‚îÄ */
#stars { position:fixed; inset:0; z-index:0; pointer-events:none; }

/* ‚îÄ‚îÄ SCREENS ‚îÄ‚îÄ */
.screen {
  position:fixed; inset:0; z-index:10;
  display:flex; flex-direction:column;
  align-items:center; justify-content:center;
  padding:24px 20px;
  overflow-y:auto;
  opacity:0; pointer-events:none;
  transition:opacity 0.6s ease;
}
.screen.active { opacity:1; pointer-events:all; }

/* ‚îÄ‚îÄ INTRO ‚îÄ‚îÄ */
#screen-intro {
  background: radial-gradient(ellipse at 50% 30%, rgba(138,110,255,0.15) 0%, transparent 70%),
              radial-gradient(ellipse at 50% 80%, rgba(255,110,180,0.08) 0%, transparent 60%),
              var(--void);
  text-align:center;
  gap:0;
}
.sigil {
  width:120px; height:120px;
  margin-bottom:24px;
  animation: sigil-spin 20s linear infinite;
  filter: drop-shadow(0 0 20px rgba(138,110,255,0.6));
}
@keyframes sigil-spin { to { transform: rotate(360deg); } }

.title-main {
  font-family:'Cinzel', serif;
  font-size:2.2rem;
  font-weight:900;
  letter-spacing:6px;
  color:#fff;
  text-shadow: 0 0 30px rgba(138,110,255,0.8), 0 0 60px rgba(138,110,255,0.4);
  margin-bottom:6px;
}
.title-sub {
  font-family:'Crimson Pro', serif;
  font-style:italic;
  font-size:1rem;
  color:var(--muted);
  letter-spacing:3px;
  margin-bottom:40px;
}

.btn-main {
  background: linear-gradient(135deg, rgba(138,110,255,0.2), rgba(255,110,180,0.15));
  border: 1px solid var(--border);
  color: var(--text);
  font-family:'Cinzel', serif;
  font-size:0.9rem;
  letter-spacing:3px;
  padding:16px 40px;
  cursor:pointer;
  transition:all 0.3s;
  position:relative;
  overflow:hidden;
  width:100%;
  max-width:280px;
  margin-bottom:12px;
}
.btn-main::before {
  content:'';
  position:absolute;
  inset:0;
  background:linear-gradient(135deg, rgba(138,110,255,0.4), rgba(255,110,180,0.3));
  opacity:0;
  transition:opacity 0.3s;
}
.btn-main:active::before { opacity:1; }
.btn-main.primary {
  background:linear-gradient(135deg, rgba(138,110,255,0.35), rgba(255,110,180,0.25));
  border-color:rgba(138,110,255,0.6);
  color:#fff;
  font-size:1rem;
}

/* ‚îÄ‚îÄ SETUP SCREEN ‚îÄ‚îÄ */
#screen-setup {
  background: var(--deep);
  gap:0;
  padding-top:60px;
  justify-content:flex-start;
}
.screen-header {
  width:100%;
  display:flex;
  align-items:center;
  gap:12px;
  margin-bottom:32px;
  padding-top:8px;
}
.back-btn {
  background:none;
  border:1px solid var(--border);
  color:var(--muted);
  font-family:'Cinzel', serif;
  font-size:0.7rem;
  letter-spacing:2px;
  padding:8px 14px;
  cursor:pointer;
}
.screen-title {
  font-family:'Cinzel', serif;
  font-size:1rem;
  letter-spacing:4px;
  color:var(--text);
}

.section-label {
  font-family:'Cinzel', serif;
  font-size:0.65rem;
  letter-spacing:3px;
  color:var(--muted);
  margin-bottom:12px;
  width:100%;
  text-transform:uppercase;
}

/* INTENTION */
.intention-input {
  width:100%;
  background:rgba(138,110,255,0.05);
  border:1px solid var(--border);
  border-radius:2px;
  color:var(--text);
  font-family:'Crimson Pro', serif;
  font-size:1.1rem;
  padding:14px 16px;
  outline:none;
  resize:none;
  height:80px;
  margin-bottom:24px;
  transition:border-color 0.3s;
}
.intention-input:focus { border-color:rgba(138,110,255,0.6); }
.intention-input::placeholder { color:var(--muted); font-style:italic; }

/* RADIUS SLIDER */
.radius-display {
  font-family:'Cinzel', serif;
  font-size:2rem;
  font-weight:600;
  color:#fff;
  text-align:center;
  margin-bottom:4px;
  letter-spacing:2px;
}
.radius-unit { font-size:0.9rem; color:var(--muted); }
.slider-track {
  width:100%;
  margin:12px 0 24px;
  position:relative;
}
input[type=range] {
  -webkit-appearance:none;
  width:100%;
  height:2px;
  background:linear-gradient(to right, var(--glow) 0%, var(--glow) var(--pct, 50%), rgba(138,110,255,0.2) var(--pct,50%));
  outline:none;
  cursor:pointer;
}
input[type=range]::-webkit-slider-thumb {
  -webkit-appearance:none;
  width:22px; height:22px;
  border-radius:50%;
  background:var(--glow);
  box-shadow:0 0 12px rgba(138,110,255,0.8);
  cursor:pointer;
}

/* TYPE CARDS */
.type-grid {
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
  width:100%;
  margin-bottom:28px;
}
.type-card {
  background:rgba(255,255,255,0.03);
  border:1px solid var(--border);
  padding:14px 12px;
  cursor:pointer;
  transition:all 0.25s;
  position:relative;
  overflow:hidden;
  text-align:center;
}
.type-card.selected { border-color:var(--type-color); background:rgba(var(--type-rgb),0.12); }
.type-card.selected::after {
  content:'';
  position:absolute;
  inset:0;
  box-shadow:inset 0 0 20px rgba(var(--type-rgb),0.15);
}
.type-icon { font-size:1.8rem; margin-bottom:6px; display:block; }
.type-name {
  font-family:'Cinzel', serif;
  font-size:0.7rem;
  letter-spacing:2px;
  color:var(--text);
  display:block;
  margin-bottom:4px;
}
.type-hint {
  font-family:'Crimson Pro', serif;
  font-size:0.75rem;
  color:var(--muted);
  font-style:italic;
  line-height:1.3;
}

/* ‚îÄ‚îÄ ANOMALY INFO SCREEN ‚îÄ‚îÄ */
#screen-anomaly {
  background:var(--deep);
  gap:0;
  padding-top:60px;
  justify-content:flex-start;
}
.anomaly-hero {
  width:100%;
  padding:28px 20px;
  margin-bottom:20px;
  text-align:center;
  position:relative;
  overflow:hidden;
}
.anomaly-hero::before {
  content:'';
  position:absolute;
  inset:0;
  background:radial-gradient(ellipse at 50% 50%, rgba(var(--type-rgb-hero),0.2), transparent 70%);
}
.anomaly-big-icon { font-size:4rem; display:block; margin-bottom:12px; }
.anomaly-big-name {
  font-family:'Cinzel', serif;
  font-size:1.5rem;
  font-weight:900;
  letter-spacing:5px;
  margin-bottom:8px;
}
.anomaly-tagline {
  font-family:'Crimson Pro', serif;
  font-style:italic;
  font-size:1rem;
  color:var(--muted);
}

.info-block {
  width:100%;
  background:rgba(255,255,255,0.03);
  border:1px solid var(--border);
  border-left-width:3px;
  padding:16px;
  margin-bottom:12px;
}
.info-block-title {
  font-family:'Cinzel', serif;
  font-size:0.65rem;
  letter-spacing:3px;
  color:var(--muted);
  margin-bottom:8px;
}
.info-block-text {
  font-family:'Crimson Pro', serif;
  font-size:1rem;
  color:var(--text);
  line-height:1.7;
}

/* ‚îÄ‚îÄ GENERATE SCREEN ‚îÄ‚îÄ */
#screen-generate {
  background: radial-gradient(ellipse at 50% 40%, rgba(138,110,255,0.1) 0%, transparent 65%), var(--deep);
  text-align:center;
  gap:24px;
}
.orb-container {
  position:relative;
  width:180px; height:180px;
  cursor:pointer;
}
.orb {
  width:100%; height:100%;
  border-radius:50%;
  background:radial-gradient(ellipse at 35% 35%, rgba(var(--orb-r),0.5) 0%, rgba(var(--orb-r),0.1) 50%, transparent 70%),
             rgba(var(--orb-r),0.08);
  border:1px solid rgba(var(--orb-r),0.4);
  box-shadow:0 0 40px rgba(var(--orb-r),0.3), 0 0 80px rgba(var(--orb-r),0.15);
  animation:orb-breathe 4s ease-in-out infinite;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:3.5rem;
  transition:all 0.3s;
}
@keyframes orb-breathe {
  0%,100%{transform:scale(1); box-shadow:0 0 40px rgba(var(--orb-r),0.3), 0 0 80px rgba(var(--orb-r),0.15);}
  50%{transform:scale(1.04); box-shadow:0 0 60px rgba(var(--orb-r),0.5), 0 0 120px rgba(var(--orb-r),0.25);}
}
.orb:active { transform:scale(0.95); }
.orb-ring {
  position:absolute; inset:-12px;
  border-radius:50%;
  border:1px dashed rgba(var(--orb-r),0.3);
  animation:ring-spin 8s linear infinite;
}
.orb-ring2 {
  position:absolute; inset:-24px;
  border-radius:50%;
  border:1px dashed rgba(var(--orb-r),0.15);
  animation:ring-spin 15s linear infinite reverse;
}
@keyframes ring-spin { to{transform:rotate(360deg)} }

.gen-label {
  font-family:'Crimson Pro', serif;
  font-style:italic;
  font-size:0.9rem;
  color:var(--muted);
}
.gen-type-badge {
  font-family:'Cinzel', serif;
  font-size:0.7rem;
  letter-spacing:3px;
  padding:6px 16px;
  border:1px solid rgba(var(--orb-r),0.4);
  color:rgb(var(--orb-r));
  background:rgba(var(--orb-r),0.08);
}
.gen-intention-display {
  font-family:'Crimson Pro', serif;
  font-style:italic;
  font-size:0.95rem;
  color:var(--muted);
  max-width:280px;
  line-height:1.5;
}
.gen-radius-display {
  font-family:'Cinzel', serif;
  font-size:0.75rem;
  letter-spacing:2px;
  color:var(--muted);
}

/* ‚îÄ‚îÄ LOADING ‚îÄ‚îÄ */
#screen-loading {
  background:var(--deep);
  gap:20px;
  text-align:center;
}
.loading-sigil {
  width:80px; height:80px;
  animation:sigil-spin 2s linear infinite;
  filter:drop-shadow(0 0 15px rgba(138,110,255,0.7));
}
.loading-text {
  font-family:'Cinzel', serif;
  font-size:0.8rem;
  letter-spacing:4px;
  color:var(--muted);
  animation:fade-pulse 1.5s ease-in-out infinite;
}
@keyframes fade-pulse{0%,100%{opacity:0.4}50%{opacity:1}}
.loading-phase {
  font-family:'Crimson Pro', serif;
  font-style:italic;
  font-size:0.9rem;
  color:var(--text);
  min-height:24px;
}

/* ‚îÄ‚îÄ MAP SCREEN ‚îÄ‚îÄ */
#screen-map {
  padding:0;
  flex-direction:column;
  background:var(--void);
}
#map {
  flex:1;
  width:100%;
  position:relative;
}
.map-overlay-top {
  position:absolute;
  top:0; left:0; right:0;
  z-index:1000;
  pointer-events:none;
}
.map-top-bar {
  background:linear-gradient(to bottom, rgba(4,5,10,0.95), transparent);
  padding:12px 16px 24px;
  display:flex;
  align-items:center;
  gap:12px;
  pointer-events:all;
}
.map-back {
  background:rgba(4,5,10,0.8);
  border:1px solid var(--border);
  color:var(--muted);
  font-family:'Cinzel', serif;
  font-size:0.65rem;
  letter-spacing:2px;
  padding:8px 12px;
  cursor:pointer;
  flex-shrink:0;
}
.map-type-pill {
  font-family:'Cinzel', serif;
  font-size:0.65rem;
  letter-spacing:2px;
  padding:6px 12px;
  border:1px solid rgba(var(--orb-r),0.5);
  color:rgb(var(--orb-r));
  background:rgba(var(--orb-r),0.1);
}

.map-bottom-panel {
  background:linear-gradient(to top, rgba(4,5,10,0.98) 60%, transparent);
  padding:24px 16px 20px;
  pointer-events:all;
}
.dest-info {
  display:flex;
  align-items:center;
  gap:12px;
  margin-bottom:14px;
}
.dest-icon { font-size:1.8rem; }
.dest-details { flex:1; }
.dest-name {
  font-family:'Cinzel', serif;
  font-size:0.85rem;
  letter-spacing:2px;
  color:#fff;
  margin-bottom:2px;
}
.dest-dist {
  font-family:'Crimson Pro', serif;
  font-size:0.85rem;
  color:var(--muted);
}
.dest-coords {
  font-family:'Cinzel', serif;
  font-size:0.65rem;
  letter-spacing:1px;
  color:var(--muted);
  margin-bottom:14px;
}
.map-actions {
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
}
.map-btn {
  background:rgba(255,255,255,0.05);
  border:1px solid var(--border);
  color:var(--text);
  font-family:'Cinzel', serif;
  font-size:0.7rem;
  letter-spacing:2px;
  padding:12px;
  cursor:pointer;
  transition:all 0.2s;
  text-align:center;
}
.map-btn:active { background:rgba(138,110,255,0.15); }
.map-btn.primary-action {
  border-color:rgba(138,110,255,0.6);
  background:rgba(138,110,255,0.1);
  color:rgb(var(--orb-r));
  grid-column:1/-1;
}

/* Leaflet dark */
.leaflet-tile { filter:invert(1) hue-rotate(180deg) brightness(0.75) saturate(0.6) contrast(1.1); }
.leaflet-container { background:#04050a; }
.leaflet-control-zoom { display:none; }

/* Custom markers */
.dest-marker {
  display:flex; flex-direction:column; align-items:center;
  animation:marker-pulse 2s ease-in-out infinite;
}
@keyframes marker-pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
.dest-marker-inner {
  width:40px; height:40px; border-radius:50%;
  display:flex; align-items:center; justify-content:center;
  font-size:1.3rem;
  border:2px solid;
  box-shadow:0 0 20px;
}
.dest-marker-dot {
  width:6px; height:6px; border-radius:50%;
  margin-top:4px;
}
.me-marker {
  width:16px; height:16px; border-radius:50%;
  background:#fff;
  border:3px solid var(--glow);
  box-shadow:0 0 12px rgba(138,110,255,0.8);
  animation:me-pulse 2s ease-in-out infinite;
}
@keyframes me-pulse{0%,100%{box-shadow:0 0 12px rgba(138,110,255,0.8)}50%{box-shadow:0 0 24px rgba(138,110,255,1)}}

/* ‚îÄ‚îÄ RESULT SCREEN ‚îÄ‚îÄ */
#screen-result {
  background:var(--deep);
  gap:0;
  padding-top:60px;
  justify-content:flex-start;
  text-align:center;
}
.result-aura {
  width:80px; height:80px; border-radius:50%;
  display:flex; align-items:center; justify-content:center;
  font-size:2.5rem;
  margin:0 auto 20px;
  border:1px solid;
  box-shadow:0 0 30px;
}
.result-title {
  font-family:'Cinzel', serif;
  font-size:1.1rem;
  letter-spacing:4px;
  color:#fff;
  margin-bottom:8px;
}
.result-subtitle {
  font-family:'Crimson Pro', serif;
  font-style:italic;
  font-size:0.95rem;
  color:var(--muted);
  margin-bottom:28px;
  padding:0 20px;
}
textarea.journal-entry {
  width:100%;
  background:rgba(255,255,255,0.03);
  border:1px solid var(--border);
  color:var(--text);
  font-family:'Crimson Pro', serif;
  font-size:1rem;
  padding:14px;
  resize:none;
  height:120px;
  outline:none;
  margin-bottom:16px;
  line-height:1.6;
}
textarea.journal-entry::placeholder { color:var(--muted); font-style:italic; }
.result-actions { width:100%; display:grid; gap:10px; }

/* ‚îÄ‚îÄ HISTORY SCREEN ‚îÄ‚îÄ */
#screen-history {
  background:var(--deep);
  gap:0;
  padding-top:60px;
  justify-content:flex-start;
}
.history-empty {
  text-align:center;
  padding:40px 20px;
  font-family:'Crimson Pro', serif;
  font-style:italic;
  color:var(--muted);
  font-size:1rem;
}
.history-card {
  width:100%;
  background:rgba(255,255,255,0.03);
  border:1px solid var(--border);
  border-left:3px solid;
  padding:14px;
  margin-bottom:10px;
  cursor:pointer;
}
.history-card-top { display:flex; align-items:center; gap:10px; margin-bottom:6px; }
.history-card-icon { font-size:1.3rem; }
.history-card-name {
  font-family:'Cinzel', serif;
  font-size:0.75rem;
  letter-spacing:2px;
  flex:1;
}
.history-card-date {
  font-family:'Crimson Pro', serif;
  font-size:0.75rem;
  color:var(--muted);
}
.history-card-note {
  font-family:'Crimson Pro', serif;
  font-style:italic;
  font-size:0.85rem;
  color:var(--muted);
  line-height:1.5;
  overflow:hidden;
  display:-webkit-box;
  -webkit-line-clamp:2;
  -webkit-box-orient:vertical;
}

/* ‚îÄ‚îÄ TOASTS ‚îÄ‚îÄ */
.toast {
  position:fixed; bottom:30px; left:50%; transform:translateX(-50%);
  background:rgba(12,16,32,0.95);
  border:1px solid var(--border);
  color:var(--text);
  font-family:'Crimson Pro', serif;
  font-size:0.9rem;
  padding:12px 20px;
  z-index:9999;
  white-space:nowrap;
  opacity:0;
  transition:opacity 0.3s;
  pointer-events:none;
}
.toast.show { opacity:1; }

/* Scrollable sections */
.scroll-area { overflow-y:auto; width:100%; flex:1; padding-bottom:20px; }
</style>
</head>
<body>

<canvas id="stars"></canvas>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê INTRO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-intro" class="screen active">
  <svg class="sigil" viewBox="0 0 120 120" fill="none" xmlns="http://www.w3.org/2000/svg">
    <circle cx="60" cy="60" r="55" stroke="rgba(138,110,255,0.3)" stroke-width="1"/>
    <circle cx="60" cy="60" r="40" stroke="rgba(138,110,255,0.2)" stroke-width="1" stroke-dasharray="4 4"/>
    <path d="M60 5 L60 115 M5 60 L115 60" stroke="rgba(138,110,255,0.15)" stroke-width="0.5"/>
    <path d="M60 5 L113 37.5 L113 82.5 L60 115 L7 82.5 L7 37.5 Z" stroke="rgba(255,110,180,0.25)" stroke-width="1" fill="none"/>
    <path d="M60 20 L95 42 L95 78 L60 100 L25 78 L25 42 Z" stroke="rgba(138,110,255,0.4)" stroke-width="1" fill="none"/>
    <circle cx="60" cy="60" r="8" stroke="rgba(255,110,180,0.6)" stroke-width="1.5" fill="rgba(255,110,180,0.1)"/>
    <path d="M60 52 L60 35 M60 68 L60 85 M52 60 L35 60 M68 60 L85 60" stroke="rgba(255,110,180,0.4)" stroke-width="1"/>
    <circle cx="60" cy="20" r="3" fill="rgba(138,110,255,0.8)"/>
    <circle cx="95" cy="42" r="3" fill="rgba(138,110,255,0.6)"/>
    <circle cx="95" cy="78" r="3" fill="rgba(138,110,255,0.6)"/>
    <circle cx="60" cy="100" r="3" fill="rgba(138,110,255,0.8)"/>
    <circle cx="25" cy="78" r="3" fill="rgba(138,110,255,0.6)"/>
    <circle cx="25" cy="42" r="3" fill="rgba(138,110,255,0.6)"/>
  </svg>
  <div class="title-main">RANDONAUT</div>
  <div class="title-sub">explora lo desconocido</div>
  <button class="btn-main primary" onclick="goTo('setup')">‚ú¶ INICIAR EXPLORACI√ìN</button>
  <button class="btn-main" onclick="goTo('history')">HISTORIAL DE VIAJES</button>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SETUP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-setup" class="screen">
  <div class="screen-header">
    <button class="back-btn" onclick="goTo('intro')">‚Üê VOLVER</button>
    <div class="screen-title">CONFIGURAR</div>
  </div>
  <div class="scroll-area">

  <div class="section-label">‚ú¶ tu intenci√≥n</div>
  <textarea class="intention-input" id="intention-input" placeholder="Escribe una palabra, emoci√≥n o deseo antes de explorar..."></textarea>

  <div class="section-label">‚ú¶ radio de b√∫squeda</div>
  <div class="radius-display"><span id="radius-val">1000</span> <span class="radius-unit">metros</span></div>
  <div class="slider-track">
    <input type="range" id="radius-slider" min="200" max="5000" step="100" value="1000" oninput="updateRadius(this)">
  </div>

  <div class="section-label">‚ú¶ tipo de anomal√≠a</div>
  <div class="type-grid" id="type-grid">
    <div class="type-card selected" data-type="attractor" style="--type-color:#6effb4;--type-rgb:110,255,180" onclick="selectType(this)">
      <span class="type-icon">üåÄ</span>
      <span class="type-name">ATTRACTOR</span>
      <span class="type-hint">energ√≠a concentrada</span>
    </div>
    <div class="type-card" data-type="void" style="--type-color:#6ebbff;--type-rgb:110,187,255" onclick="selectType(this)">
      <span class="type-icon">üï≥Ô∏è</span>
      <span class="type-name">VOID</span>
      <span class="type-hint">vac√≠o cu√°ntico</span>
    </div>
    <div class="type-card" data-type="anomaly" style="--type-color:#ff6eb4;--type-rgb:255,110,180" onclick="selectType(this)">
      <span class="type-icon">‚ö°</span>
      <span class="type-name">ANOMALY</span>
      <span class="type-hint">punto estad√≠stico raro</span>
    </div>
    <div class="type-card" data-type="power" style="--type-color:#ffdd6e;--type-rgb:255,221,110" onclick="selectType(this)">
      <span class="type-icon">‚ú®</span>
      <span class="type-name">POWER</span>
      <span class="type-hint">convergencia m√°xima</span>
    </div>
  </div>

  <div style="margin-bottom:8px">
    <button class="btn-main" style="max-width:100%;margin-bottom:0" onclick="showAnomalyInfo()">‚ùì ¬øQu√© significa cada tipo?</button>
  </div>
  <div style="height:12px"></div>
  <button class="btn-main primary" style="max-width:100%" onclick="goToGenerate()">CONTINUAR ‚Üí</button>
  <div style="height:30px"></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ANOMALY INFO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-anomaly" class="screen">
  <div class="screen-header">
    <button class="back-btn" onclick="goTo('setup')">‚Üê VOLVER</button>
    <div class="screen-title">TIPOS</div>
  </div>
  <div class="scroll-area" id="anomaly-info-content"></div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê GENERATE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-generate" class="screen">
  <div class="gen-type-badge" id="gen-type-badge">ATTRACTOR</div>
  <div class="gen-intention-display" id="gen-intention-display" style="display:none"></div>
  <div class="orb-container" onclick="generatePoint()">
    <div class="orb-ring2"></div>
    <div class="orb-ring"></div>
    <div class="orb" id="gen-orb">üåÄ</div>
  </div>
  <div class="gen-label">Toca el orbe para generar</div>
  <div class="gen-radius-display" id="gen-radius-display">Radio: 1000m</div>
  <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:center">
    <button class="btn-main btn-sm" style="max-width:160px;font-size:0.75rem;padding:10px 20px" onclick="goTo('setup')">‚Üê AJUSTES</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LOADING ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-loading" class="screen">
  <svg class="loading-sigil" viewBox="0 0 80 80" fill="none">
    <circle cx="40" cy="40" r="35" stroke="rgba(138,110,255,0.5)" stroke-width="1.5" stroke-dasharray="6 4"/>
    <circle cx="40" cy="40" r="22" stroke="rgba(255,110,180,0.4)" stroke-width="1" stroke-dasharray="3 5"/>
    <circle cx="40" cy="40" r="6" fill="rgba(138,110,255,0.6)"/>
    <path d="M40 5 L40 75 M5 40 L75 40" stroke="rgba(138,110,255,0.2)" stroke-width="0.5"/>
  </svg>
  <div class="loading-text">CALCULANDO</div>
  <div class="loading-phase" id="loading-phase">Consultando el campo cu√°ntico...</div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MAP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-map" class="screen" style="padding:0">
  <div id="map">
    <div class="map-overlay-top">
      <div class="map-top-bar">
        <button class="map-back" onclick="goTo('generate')">‚Üê</button>
        <div class="map-type-pill" id="map-type-pill">ATTRACTOR</div>
      </div>
    </div>
  </div>
  <div class="map-bottom-panel">
    <div class="dest-info">
      <div class="dest-icon" id="dest-icon">üåÄ</div>
      <div class="dest-details">
        <div class="dest-name" id="dest-name">PUNTO ATTRACTOR</div>
        <div class="dest-dist" id="dest-dist">Calculando distancia...</div>
      </div>
    </div>
    <div class="dest-coords" id="dest-coords">---.----¬∞, ---.----¬∞</div>
    <div class="map-actions">
      <button class="map-btn" onclick="openInMaps()">üìç Abrir en Maps</button>
      <button class="map-btn" onclick="recenter()">üéØ Centrar mapa</button>
      <button class="map-btn primary-action" onclick="arriveAtDestination()">‚ú¶ LLEGU√â AL DESTINO</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RESULT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-result" class="screen">
  <div class="result-aura" id="result-aura">üåÄ</div>
  <div class="result-title">¬øQU√â ENCONTRASTE?</div>
  <div class="result-subtitle">Registra tu experiencia. El universo siempre tiene algo que mostrar.</div>
  <textarea class="journal-entry" id="journal-entry" placeholder="Describe lo que viste, sentiste o descubriste en este punto..."></textarea>
  <div class="result-actions">
    <button class="btn-main primary" style="max-width:100%;margin-bottom:0" onclick="saveEntry()">‚ú¶ GUARDAR EXPERIENCIA</button>
    <button class="btn-main" style="max-width:100%;margin-bottom:0" onclick="newTrip()">‚Ü∫ NUEVA EXPLORACI√ìN</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HISTORY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-history" class="screen">
  <div class="screen-header">
    <button class="back-btn" onclick="goTo('intro')">‚Üê VOLVER</button>
    <div class="screen-title">HISTORIAL</div>
  </div>
  <div class="scroll-area" id="history-list"></div>
</div>

<div class="toast" id="toast"></div>

<script>
// ‚îÄ‚îÄ‚îÄ STAR CANVAS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const canvas = document.getElementById('stars');
const ctx = canvas.getContext('2d');
let stars = [];
function resizeCanvas() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  stars = Array.from({length:120}, () => ({
    x: Math.random()*canvas.width, y: Math.random()*canvas.height,
    r: Math.random()*1.2+0.2, o: Math.random()*0.6+0.1,
    s: (Math.random()-0.5)*0.1
  }));
}
function animStars() {
  ctx.clearRect(0,0,canvas.width,canvas.height);
  stars.forEach(s => {
    s.o += s.s;
    if (s.o > 0.7 || s.o < 0.05) s.s *= -1;
    ctx.beginPath();
    ctx.arc(s.x, s.y, s.r, 0, Math.PI*2);
    ctx.fillStyle = `rgba(200,190,255,${s.o})`;
    ctx.fill();
  });
  requestAnimationFrame(animStars);
}
resizeCanvas();
animStars();
window.addEventListener('resize', resizeCanvas);

// ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let currentScreen = 'intro';
let selectedType = 'attractor';
let intention = '';
let radius = 1000;
let myLat, myLng, destLat, destLng;
let mapInstance = null, meMarker = null, destMarker = null, radiusCircle = null;
let currentEntry = null;

const TYPES = {
  attractor: {
    name:'ATTRACTOR', icon:'üåÄ', color:'#6effb4', rgb:'110,255,180',
    tagline:'Donde la energ√≠a converge',
    what:'Un punto donde los n√∫meros aleatorios cu√°nticos se agrupan estad√≠sticamente, como si algo "atrajera" la aleatoriedad hacia ese lugar.',
    expect:'Lugares con mucha energ√≠a humana: plazas concurridas, graffitis significativos, √°rboles viejos, esculturas, o algo que llame poderosamente tu atenci√≥n sin raz√≥n aparente.',
    ritual:'Al llegar, detente un momento. Cierra los ojos 10 segundos. ¬øQu√© sientes? ¬øHay algo inusual? Nota los colores, sonidos y sensaciones.',
    intention:'Usa este tipo cuando busques encontrar algo o cuando tengas una pregunta sin respuesta.'
  },
  void: {
    name:'VOID', icon:'üï≥Ô∏è', color:'#6ebbff', rgb:'110,187,255',
    tagline:'El vac√≠o entre las cosas',
    what:'Lo opuesto al Attractor: un punto donde la aleatoriedad cu√°ntica se dispersa al m√°ximo, creando un "hueco" estad√≠stico en el espacio.',
    expect:'Lugares vac√≠os, tranquilos o abandonados. Callejones olvidados, parques desiertos, espacios entre edificios, lugares que la gente pasa por alto. Una quietud inusual.',
    ritual:'Si√©ntate en silencio si puedes. El Void invita a la reflexi√≥n. ¬øQu√© pensamientos llegan en este espacio vac√≠o?',
    intention:'Ideal cuando necesitas claridad mental, silencio interior, o cuando quieres "vaciar" algo de tu vida.'
  },
  anomaly: {
    name:'ANOMALY', icon:'‚ö°', color:'#ff6eb4', rgb:'255,110,180',
    tagline:'Donde las probabilidades fallan',
    what:'Un punto estad√≠sticamente improbable: tan extra√±o en los datos que desaf√≠a el azar. Como un error en la matriz.',
    expect:'Cosas fuera de lugar: arte callejero perturbador, objetos abandonados con historia, encuentros inesperados, algo que definitivamente no deber√≠a estar ah√≠ pero est√°.',
    ritual:'Documenta todo con fotos. Las anomal√≠as a menudo revelan sus secretos despu√©s, no en el momento. Presta atenci√≥n a los detalles m√°s peque√±os.',
    intention:'Para quienes buscan experiencias perturbadoras, sincron√≠as o "glitches en la realidad". Alto potencial de encuentros extra√±os.'
  },
  power: {
    name:'POWER', icon:'‚ú®', color:'#ffdd6e', rgb:'255,221,110',
    tagline:'La convergencia m√°xima',
    what:'Un punto Power combina las propiedades del Attractor y la Anomaly: energ√≠a concentrada en un lugar estad√≠sticamente singular. El m√°s raro de todos.',
    expect:'Algo significativo que conecta con tu intenci√≥n de forma que no podr√°s explicar racionalmente. Muchos reportan encontrar exactamente lo que buscaban, o algo mejor.',
    ritual:'Lleva un objeto personal. Pasa al menos 5 minutos en el punto. Escribe o graba tus pensamientos en el momento mismo.',
    intention:'√ösalo solo cuando tengas una intenci√≥n muy clara y poderosa. No lo malgastes en curiosidad superficial.'
  }
};

// ‚îÄ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function goTo(screen) {
  document.getElementById('screen-' + currentScreen).classList.remove('active');
  document.getElementById('screen-' + screen).classList.add('active');
  currentScreen = screen;
  if (screen === 'history') renderHistory();
}

function showToast(msg, dur=2500) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), dur);
}

// ‚îÄ‚îÄ‚îÄ TYPE SELECTION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function selectType(card) {
  document.querySelectorAll('.type-card').forEach(c => c.classList.remove('selected'));
  card.classList.add('selected');
  selectedType = card.dataset.type;
}

// ‚îÄ‚îÄ‚îÄ RADIUS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateRadius(input) {
  radius = parseInt(input.value);
  document.getElementById('radius-val').textContent = radius >= 1000 ? (radius/1000).toFixed(1) + ' km'.split('').reverse().join('').split('').reverse().join('') : radius;
  // Actually just show raw value nicely
  document.getElementById('radius-val').textContent = radius >= 1000 ? (radius/1000).toFixed(1) : radius;
  document.querySelector('.radius-unit').textContent = radius >= 1000 ? 'km' : 'metros';
  const pct = ((radius-200)/(5000-200)*100).toFixed(1);
  input.style.setProperty('--pct', pct + '%');
}
// init
document.getElementById('radius-slider').style.setProperty('--pct','20%');

// ‚îÄ‚îÄ‚îÄ ANOMALY INFO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showAnomalyInfo() {
  const content = document.getElementById('anomaly-info-content');
  content.innerHTML = Object.entries(TYPES).map(([key, t]) => `
    <div style="margin-bottom:20px">
      <div class="anomaly-hero" style="--type-rgb-hero:${t.rgb}">
        <span class="anomaly-big-icon">${t.icon}</span>
        <div class="anomaly-big-name" style="color:${t.color}">${t.name}</div>
        <div class="anomaly-tagline">${t.tagline}</div>
      </div>
      <div class="info-block" style="border-left-color:${t.color}">
        <div class="info-block-title">¬øQU√â ES?</div>
        <div class="info-block-text">${t.what}</div>
      </div>
      <div class="info-block" style="border-left-color:${t.color}">
        <div class="info-block-title">¬øQU√â ESPERAR?</div>
        <div class="info-block-text">${t.expect}</div>
      </div>
      <div class="info-block" style="border-left-color:${t.color}">
        <div class="info-block-title">RITUAL AL LLEGAR</div>
        <div class="info-block-text">${t.ritual}</div>
      </div>
      <div class="info-block" style="border-left-color:${t.color}">
        <div class="info-block-title">MEJOR PARA</div>
        <div class="info-block-text">${t.intention}</div>
      </div>
    </div>
  `).join('<hr style="border:none;border-top:1px solid var(--border);margin:10px 0 20px">');
  goTo('anomaly');
}

// ‚îÄ‚îÄ‚îÄ GO TO GENERATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function goToGenerate() {
  intention = document.getElementById('intention-input').value.trim();
  const t = TYPES[selectedType];
  const orb = document.getElementById('gen-orb');
  orb.textContent = t.icon;
  orb.style.setProperty('--orb-r', t.rgb);
  document.querySelector('.orb-ring').style.setProperty('--orb-r', t.rgb);
  document.querySelector('.orb-ring2').style.setProperty('--orb-r', t.rgb);
  document.getElementById('gen-type-badge').textContent = t.name;
  document.getElementById('gen-type-badge').style.cssText = `border-color:rgba(${t.rgb},0.5);color:rgb(${t.rgb});background:rgba(${t.rgb},0.08)`;
  document.getElementById('gen-radius-display').textContent = `Radio: ${radius >= 1000 ? (radius/1000).toFixed(1)+'km' : radius+'m'}`;
  const intEl = document.getElementById('gen-intention-display');
  if (intention) {
    intEl.textContent = `"${intention}"`;
    intEl.style.display = 'block';
  } else {
    intEl.style.display = 'none';
  }
  // Set CSS vars for orb rings
  document.querySelector('.orb').style.background = `radial-gradient(ellipse at 35% 35%, rgba(${t.rgb},0.5) 0%, rgba(${t.rgb},0.1) 50%, transparent 70%), rgba(${t.rgb},0.08)`;
  document.querySelector('.orb').style.borderColor = `rgba(${t.rgb},0.4)`;
  document.querySelector('.orb').style.boxShadow = `0 0 40px rgba(${t.rgb},0.3), 0 0 80px rgba(${t.rgb},0.15)`;
  goTo('generate');
}

// ‚îÄ‚îÄ‚îÄ GENERATE POINT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const LOADING_PHASES = [
  'Consultando el campo cu√°ntico...',
  'Analizando fluctuaciones de aleatoriedad...',
  'Calculando distribuci√≥n estad√≠stica...',
  'Filtrando ruido del universo...',
  'Convergiendo coordenadas...',
  'Tu punto est√° listo.'
];

async function generatePoint() {
  goTo('loading');
  let phase = 0;
  const phaseEl = document.getElementById('loading-phase');
  const phaseInterval = setInterval(() => {
    phaseEl.textContent = LOADING_PHASES[Math.min(phase++, LOADING_PHASES.length-1)];
  }, 600);

  // Get location
  try {
    const pos = await getLocation();
    myLat = pos.coords.latitude;
    myLng = pos.coords.longitude;
  } catch(e) {
    // Default to Santiago if no GPS
    myLat = -33.4489 + (Math.random()-0.5)*0.01;
    myLng = -70.6693 + (Math.random()-0.5)*0.01;
    showToast('üìç Usando ubicaci√≥n aproximada');
  }

  // Generate random point within radius
  await sleep(3500);
  clearInterval(phaseInterval);
  phaseEl.textContent = 'Tu punto est√° listo.';
  await sleep(600);

  const point = randomPointInRadius(myLat, myLng, radius);
  destLat = point.lat;
  destLng = point.lng;

  showMap();
}

function getLocation() {
  return new Promise((res, rej) => {
    if (!navigator.geolocation) { rej(new Error('No GPS')); return; }
    navigator.geolocation.getCurrentPosition(res, rej, { enableHighAccuracy:true, timeout:8000 });
  });
}

function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

// Random point using correct geographic math
function randomPointInRadius(lat, lng, radiusM) {
  const r = radiusM / 111320;
  const u = Math.random(), v = Math.random();
  const w = r * Math.sqrt(u);
  const t = 2 * Math.PI * v;
  const x = w * Math.cos(t);
  const y = w * Math.sin(t);
  const newLat = lat + y;
  const newLng = lng + x / Math.cos(lat * Math.PI / 180);
  return { lat: newLat, lng: newLng };
}

function haversine(lat1, lng1, lat2, lng2) {
  const R = 6371000;
  const dLat = (lat2-lat1)*Math.PI/180;
  const dLng = (lng2-lng1)*Math.PI/180;
  const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLng/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

// ‚îÄ‚îÄ‚îÄ MAP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showMap() {
  goTo('map');
  const t = TYPES[selectedType];

  // Map type pill
  const pill = document.getElementById('map-type-pill');
  pill.textContent = t.name;
  pill.style.cssText = `border-color:rgba(${t.rgb},0.5);color:rgb(${t.rgb});background:rgba(${t.rgb},0.1)`;

  // Dest info
  document.getElementById('dest-icon').textContent = t.icon;
  document.getElementById('dest-name').textContent = `PUNTO ${t.name}`;
  document.getElementById('dest-coords').textContent = `${destLat.toFixed(5)}¬∞,  ${destLng.toFixed(5)}¬∞`;

  const dist = haversine(myLat, myLng, destLat, destLng);
  document.getElementById('dest-dist').textContent = dist >= 1000 ? `${(dist/1000).toFixed(2)} km de aqu√≠` : `${Math.round(dist)} m de aqu√≠`;

  // Init or update map
  if (!mapInstance) {
    mapInstance = L.map('map', { zoomControl:false, attributionControl:false });
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapInstance);
  }

  // Me marker
  const meIcon = L.divIcon({ className:'', html:'<div class="me-marker"></div>', iconSize:[16,16], iconAnchor:[8,8] });
  if (meMarker) meMarker.setLatLng([myLat, myLng]);
  else meMarker = L.marker([myLat, myLng], { icon:meIcon }).addTo(mapInstance);

  // Dest marker
  const destIcon = L.divIcon({
    className:'',
    html:`<div class="dest-marker">
      <div class="dest-marker-inner" style="background:rgba(${t.rgb},0.15);border-color:rgb(${t.rgb});box-shadow:0 0 20px rgba(${t.rgb},0.5)">${t.icon}</div>
      <div class="dest-marker-dot" style="background:rgb(${t.rgb})"></div>
    </div>`,
    iconSize:[40,52], iconAnchor:[20,48]
  });
  if (destMarker) destMarker.setLatLng([destLat, destLng]);
  else destMarker = L.marker([destLat, destLng], { icon:destIcon }).addTo(mapInstance);

  // Draw line
  if (window._polyline) mapInstance.removeLayer(window._polyline);
  window._polyline = L.polyline([[myLat,myLng],[destLat,destLng]], {
    color:`rgb(${t.rgb})`, weight:1.5, dashArray:'6 6', opacity:0.5
  }).addTo(mapInstance);

  // Radius circle
  if (radiusCircle) mapInstance.removeLayer(radiusCircle);
  radiusCircle = L.circle([myLat,myLng], {
    radius, color:`rgba(${t.rgb},0.4)`, fillColor:`rgba(${t.rgb},0.03)`, weight:1
  }).addTo(mapInstance);

  // Fit bounds
  const bounds = L.latLngBounds([[myLat,myLng],[destLat,destLng]]);
  mapInstance.fitBounds(bounds, { padding:[60,60] });

  // Live position tracking
  if (window._watchId) navigator.geolocation.clearWatch(window._watchId);
  window._watchId = navigator.geolocation.watchPosition((pos) => {
    myLat = pos.coords.latitude;
    myLng = pos.coords.longitude;
    meMarker.setLatLng([myLat, myLng]);
    const d = haversine(myLat, myLng, destLat, destLng);
    document.getElementById('dest-dist').textContent = d >= 1000 ? `${(d/1000).toFixed(2)} km de aqu√≠` : `${Math.round(d)} m de aqu√≠`;
    if (window._polyline) {
      mapInstance.removeLayer(window._polyline);
      window._polyline = L.polyline([[myLat,myLng],[destLat,destLng]], {
        color:`rgb(${t.rgb})`, weight:1.5, dashArray:'6 6', opacity:0.5
      }).addTo(mapInstance);
    }
  }, null, { enableHighAccuracy:true });
}

function recenter() {
  if (!mapInstance) return;
  const bounds = L.latLngBounds([[myLat,myLng],[destLat,destLng]]);
  mapInstance.fitBounds(bounds, { padding:[60,60] });
}

function openInMaps() {
  window.open(`https://www.google.com/maps/dir/?api=1&origin=${myLat},${myLng}&destination=${destLat},${destLng}&travelmode=walking`, '_blank');
}

function arriveAtDestination() {
  if (window._watchId) navigator.geolocation.clearWatch(window._watchId);
  const t = TYPES[selectedType];
  const aura = document.getElementById('result-aura');
  aura.textContent = t.icon;
  aura.style.cssText = `border-color:rgb(${t.rgb});box-shadow:0 0 30px rgba(${t.rgb},0.4);background:rgba(${t.rgb},0.08)`;
  document.getElementById('journal-entry').value = '';
  currentEntry = { type: selectedType, intention, lat: destLat, lng: destLng, date: Date.now(), note:'' };
  goTo('result');
}

// ‚îÄ‚îÄ‚îÄ SAVE ENTRY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function saveEntry() {
  const note = document.getElementById('journal-entry').value.trim();
  currentEntry.note = note;
  const history = JSON.parse(localStorage.getItem('randonaut_history') || '[]');
  history.unshift(currentEntry);
  localStorage.setItem('randonaut_history', JSON.stringify(history.slice(0,50)));
  showToast('‚ú¶ Experiencia guardada');
  setTimeout(() => goTo('intro'), 1500);
}

function newTrip() { goTo('setup'); }

// ‚îÄ‚îÄ‚îÄ HISTORY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderHistory() {
  const list = document.getElementById('history-list');
  const history = JSON.parse(localStorage.getItem('randonaut_history') || '[]');
  if (!history.length) {
    list.innerHTML = '<div class="history-empty">A√∫n no has guardado ning√∫n viaje.<br>¬°Sal a explorar!</div>';
    return;
  }
  list.innerHTML = history.map(e => {
    const t = TYPES[e.type] || TYPES.attractor;
    const date = new Date(e.date).toLocaleDateString('es-CL', { day:'2-digit', month:'short', year:'numeric' });
    return `<div class="history-card" style="border-left-color:${t.color}">
      <div class="history-card-top">
        <div class="history-card-icon">${t.icon}</div>
        <div class="history-card-name" style="color:${t.color}">${t.name}</div>
        <div class="history-card-date">${date}</div>
      </div>
      ${e.intention ? `<div style="font-family:'Crimson Pro',serif;font-size:0.8rem;color:rgba(212,206,255,0.5);font-style:italic;margin-bottom:4px">"${e.intention}"</div>` : ''}
      ${e.note ? `<div class="history-card-note">${e.note}</div>` : '<div class="history-card-note">Sin nota registrada.</div>'}
    </div>`;
  }).join('');
}
</script>
</body>
</html>
